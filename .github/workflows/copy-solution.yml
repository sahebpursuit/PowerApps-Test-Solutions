name: Sync-Solution-Logic-Only
on:
  workflow_dispatch:

jobs:
  sync-logic:
    runs-on: windows-latest
    env:
      SOURCE_NAME: 'ITSTCOE_OCTO_UATNext_Test_Solution'
      TARGET_NAME: 'ITSTCOE_JMFE_UATNext_Procurement_Solution'
      ENVIRONMENT_URL: ${{ secrets.ENV_URL }}

    steps:
    - uses: actions/checkout@v4

    - name: Install Power Platform Tools
      uses: microsoft/powerplatform-actions/install-tools@v1

    # 1. Export both solutions from the environment
    - name: Export Source Solution
      uses: microsoft/powerplatform-actions/export-solution@v1
      with:
        environment-url: ${{ secrets.ENV_URL }}
        solution-name: ${{ env.SOURCE_NAME }}
        solution-output-file: 'source.zip'

    - name: Export Target Solution
      uses: microsoft/powerplatform-actions/export-solution@v1
      with:
        environment-url: ${{ env.ENVIRONMENT_URL }}
        solution-name: ${{ env.TARGET_NAME }}
        solution-output-file: 'target.zip'

    # 2. Unpack both to separate folders
    - name: Unpack Solutions
      run: |
        pac solution unpack --zipfile source.zip --folder src_folder
        pac solution unpack --zipfile target.zip --folder dst_folder

    # 3. PowerShell Script to copy logic but preserve metadata
    - name: Overlay Logic
      shell: pwsh
      run: |
        $src = "./src_folder"
        $dst = "./dst_folder"

        # List of folders to sync (Flows, Apps, etc.)
        $foldersToSync = @("Workflows", "CanvasApps", "WebResources")

        foreach ($folder in $foldersToSync) {
            if (Test-Path "$src/$folder") {
                Write-Host "Syncing $folder..."
                # Copy items from source to destination, overwriting logic files
                # but we keep the filenames of the DESTINATION if they differ.
                # NOTE: This assumes file structures align.
                Copy-Item -Path "$src/$folder/*" -Destination "$dst/$folder/" -Force -Recurse
            }
        }

        Write-Host "Preserving Target Solution Identity..."
        # We explicitly DO NOT touch $dst/Other/Solution.xml 
        # We explicitly DO NOT touch $dst/EnvironmentVariableDefinitions/

    # 4. Pack the modified destination folder back into the target zip
    - name: Pack Target Solution
      uses: microsoft/powerplatform-actions/pack-solution@v1
      with:
        solution-file: 'final_sync.zip'
        solution-folder: 'dst_folder'
        solution-type: 'Unmanaged'

    # 5. Import back into the environment
    - name: Import Updated Solution
      uses: microsoft/powerplatform-actions/import-solution@v1
      with:
        environment-url: ${{ env.ENVIRONMENT_URL }}
        solution-file: 'final_sync.zip'
        force-overwrite: true
