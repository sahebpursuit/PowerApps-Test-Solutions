name: Sync-Logic-And-Translate-Prefix
on:
  workflow_dispatch:

jobs:
  overlay-and-replace:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    # Corrected path: added /actions/ to the uses string
    - name: Install Power Platform Tools
      uses: microsoft/powerplatform-actions/actions-install@v1

    # 1. Export and Unpack (Source & Target)
    - name: Export Solutions
      shell: pwsh
      run: |
        pac solution export --url ${{ secrets.ENV_URL }} --name ITSTCOE_OCTO_UATNext_Test_Solution --outputfile source.zip
        pac solution export --url ${{ secrets.ENV_URL }} --name ITSTCOE_JMFE_UATNext_Procurement_Solution --outputfile target.zip

    - name: Unpack Solutions
      uses: microsoft/powerplatform-actions/unpack-solution@v1
      with:
        solution-file: 'source.zip'
        solution-folder: 'src_folder'
        solution-type: 'Unmanaged'

    - name: Unpack Target
      uses: microsoft/powerplatform-actions/actions/unpack-solution@v1
      with:
        solution-file: 'target.zip'
        solution-folder: 'dst_folder'
        solution-type: 'Unmanaged'

    # 2. Sync Logic and Translate Prefixes
    - name: Overlay Logic and Rename Prefixes
      shell: pwsh
      run: |
        $src = "./src_folder"
        $dst = "./dst_folder"
        
        # Prefixes to swap inside the code
        $oldPrefix = "utp"
        $newPrefix = "jmfeproc"
        
        # Syncing Workflows (Flows) and CanvasApps logic
        $folders = @("Workflows", "CanvasApps")
        foreach ($f in $folders) {
            if (Test-Path "$src/$f") {
                Write-Host "Copying $f folder..."
                # Force copy overwrites the logic but leaves solution2.xml alone
                Copy-Item -Path "$src/$f/*" -Destination "$dst/$f/" -Force -Recurse
            }
        }

        # Recursive Search and Replace inside the logic folders only
        # This keeps the environment variable names and logical names aligned to the target
        Write-Host "Translating internal logic references from $oldPrefix to $newPrefix..."
        Get-ChildItem -Path "$dst/Workflows", "$dst/CanvasApps" -Recurse -Include *.json,*.xml,*.msapp | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            $content -replace "$oldPrefix`_", "$newPrefix`_" | Set-Content $_.FullName -Encoding UTF8
        }

    # 3. Pack and Import
    - name: Pack Updated Target
      uses: microsoft/powerplatform-actions/actions/pack-solution@v1
      with:
        solution-file: 'updated_procurement.zip'
        solution-folder: 'dst_folder'
        solution-type: 'Unmanaged'

    - name: Import to Environment
      uses: microsoft/powerplatform-actions/actions/import-solution@v1
      with:
        environment-url: ${{ secrets.ENV_URL }}
        solution-file: 'updated_procurement.zip'
        force-overwrite: true
